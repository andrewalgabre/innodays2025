import{a as R}from"./chunk-V3EMBTZ5.js";import{N as V,O as L,c as A,e as F,k as D}from"./chunk-OLYYRW65.js";import{$ as g,$a as p,Fa as h,Ja as P,Oa as x,R as O,Ua as f,Va as n,Wa as a,Xa as s,_a as _,a as w,aa as u,ab as d,b as M,db as k,eb as S,f as c,fb as E,gb as I,ib as m,jb as T,m as C,va as l}from"./chunk-NXH6DGID.js";var v={facingMode:"environment",width:{ideal:1920},height:{ideal:1080},aspectRatio:1.7777777777777777};var b=class i{stream$=new C(null);isActive$=new C(!1);get streamObservable(){return this.stream$.asObservable()}get isActiveObservable(){return this.isActive$.asObservable()}startCamera(){return c(this,arguments,function*(t=v){try{let e={video:{facingMode:t.facingMode,width:t.width,height:t.height,aspectRatio:t.aspectRatio},audio:!1},r=yield navigator.mediaDevices.getUserMedia(e);return this.stream$.next(r),this.isActive$.next(!0),r}catch(e){throw console.error("Error starting camera:",e),new Error("Failed to access camera. Please ensure camera permissions are granted.")}})}stopCamera(){let t=this.stream$.value;t&&(t.getTracks().forEach(e=>e.stop()),this.stream$.next(null),this.isActive$.next(!1))}captureImage(t){return c(this,null,function*(){if(!t||t.readyState!==t.HAVE_ENOUGH_DATA)throw new Error("Video element not ready for capture");let e=document.createElement("canvas");e.width=t.videoWidth,e.height=t.videoHeight;let r=e.getContext("2d");if(!r)throw new Error("Failed to get canvas context");r.drawImage(t,0,0,e.width,e.height);let o=yield new Promise((H,B)=>{e.toBlob(y=>{y?H(y):B(new Error("Failed to create blob from canvas"))},"image/jpeg",.95)}),z=e.toDataURL("image/jpeg",.95);return{blob:o,dataUrl:z,width:e.width,height:e.height,timestamp:new Date}})}hasCamera(){return c(this,null,function*(){try{return(yield navigator.mediaDevices.enumerateDevices()).some(e=>e.kind==="videoinput")}catch{return!1}})}getCameraPermission(){return c(this,null,function*(){try{return(yield navigator.permissions.query({name:"camera"})).state==="granted"}catch{try{return(yield navigator.mediaDevices.getUserMedia({video:!0})).getTracks().forEach(e=>e.stop()),!0}catch{return!1}}})}switchCamera(t){let e=t==="user"?"environment":"user";return M(w({},v),{facingMode:e})}static \u0275fac=function(e){return new(e||i)};static \u0275prov=O({token:i,factory:i.\u0275fac,providedIn:"root"})};var $=["videoElement"];function G(i,t){i&1&&(n(0,"div",13),s(1,"lucide-icon",14),n(2,"p"),m(3,"Kamera wird gestartet..."),a()())}function K(i,t){if(i&1){let e=_();n(0,"div",15),s(1,"lucide-icon",16),n(2,"h3"),m(3,"Kamera-Fehler"),a(),n(4,"p"),m(5),a(),n(6,"button",17),p("click",function(){g(e);let o=d();return u(o.startCamera())}),s(7,"lucide-icon",18),m(8," Erneut versuchen "),a()()}if(i&2){let e=d();l(5),T(e.error)}}function Q(i,t){i&1&&s(0,"video",19,0)}function q(i,t){i&1&&(n(0,"div",20),s(1,"div",21),n(2,"div",22)(3,"p"),m(4,"Positionieren Sie die Kuhklaue im Rahmen"),a(),n(5,"p",23),m(6,"Sorgen Sie f\xFCr gute Beleuchtung und klare Sicht"),a()()())}function W(i,t){if(i&1){let e=_();n(0,"div",24)(1,"div",25)(2,"button",26),p("click",function(){g(e);let o=d();return u(o.toggleFlash())}),s(3,"lucide-icon",18),a(),n(4,"button",26),p("click",function(){g(e);let o=d();return u(o.switchCamera())}),s(5,"lucide-icon",18),a()(),n(6,"div",27)(7,"button",28),p("click",function(){g(e);let o=d();return u(o.selectImageFromGallery())}),s(8,"lucide-icon",29),a(),n(9,"button",30),p("click",function(){g(e);let o=d();return u(o.capturePhoto())}),s(10,"div",31),a()(),n(11,"div",32)(12,"div",33),s(13,"lucide-icon",34),n(14,"span"),m(15,"Tippen Sie, um das Bild aufzunehmen"),a()()()()}if(i&2){let e=d();l(2),I("active",e.flashEnabled)}}var j=class i{constructor(t,e,r){this.cameraService=t;this.imageTransferService=e;this.router=r}videoElement;isLoading=!0;error=null;isCameraActive=!1;currentConfig=v;flashEnabled=!1;stream=null;ngOnInit(){}ngAfterViewInit(){return c(this,null,function*(){try{yield this.startCamera()}catch{this.error="Failed to access camera. Please check permissions.",this.isLoading=!1}})}ngOnDestroy(){this.stopCamera()}startCamera(){return c(this,null,function*(){try{this.isLoading=!0,this.error=null,this.isCameraActive=!1,this.stream=yield this.cameraService.startCamera(this.currentConfig),this.isLoading=!1,this.isCameraActive=!0,setTimeout(()=>c(this,null,function*(){if(this.videoElement&&this.stream){let t=this.videoElement.nativeElement;t.srcObject=this.stream;try{yield t.play(),console.log("Video playing successfully")}catch(e){console.error("Play error:",e),this.error="Failed to start video preview: "+e.message,this.isCameraActive=!1}}else console.error("Video element:",this.videoElement,"Stream:",this.stream),this.error="Video element not found",this.isCameraActive=!1}),200)}catch(t){console.error("Camera error:",t),this.error=t.message||"Failed to access camera",this.isLoading=!1,this.isCameraActive=!1}})}stopCamera(){this.cameraService.stopCamera(),this.isCameraActive=!1}capturePhoto(){return c(this,null,function*(){if(!(!this.videoElement||!this.isCameraActive))try{let t=yield this.cameraService.captureImage(this.videoElement.nativeElement);this.imageTransferService.setImage(t.blob),this.router.navigate(["/analyzing"])}catch(t){this.error=t.message||"Failed to capture image"}})}switchCamera(){return c(this,null,function*(){this.stopCamera(),this.currentConfig=this.cameraService.switchCamera(this.currentConfig.facingMode),yield this.startCamera()})}toggleFlash(){this.flashEnabled=!this.flashEnabled}goBack(){this.router.navigate(["/home"])}selectImageFromGallery(){let t=document.createElement("input");t.type="file",t.accept="image/*",t.onchange=e=>{let r=e.target.files[0];r&&this.handleImageSelection(r)},t.click()}handleImageSelection(t){return c(this,null,function*(){try{let e=new Blob([t],{type:t.type});this.imageTransferService.setImage(e),this.router.navigate(["/analyzing"])}catch(e){this.error=e.message||"Failed to load image"}})}static \u0275fac=function(e){return new(e||i)(h(b),h(R),h(D))};static \u0275cmp=P({type:i,selectors:[["app-camera"]],viewQuery:function(e,r){if(e&1&&k($,5),e&2){let o;S(o=E())&&(r.videoElement=o.first)}},decls:13,vars:5,consts:[["videoElement",""],[1,"camera-container"],[1,"camera-header"],[1,"btn-icon","btn-secondary",3,"click"],["name","arrow-left"],[1,"camera-title"],[1,"spacer"],[1,"camera-view"],["class","loading-state",4,"ngIf"],["class","error-state",4,"ngIf"],["class","video-preview","autoplay","","playsinline","","muted","",4,"ngIf"],["class","guide-overlay",4,"ngIf"],["class","camera-controls",4,"ngIf"],[1,"loading-state"],["name","loader-2",1,"loading-icon","animate-spin"],[1,"error-state"],["name","alert-circle",1,"error-icon"],[1,"btn","btn-primary",3,"click"],["name","rotate-cw"],["autoplay","","playsinline","","muted","",1,"video-preview"],[1,"guide-overlay"],[1,"guide-frame"],[1,"guide-text"],[1,"text-muted"],[1,"camera-controls"],[1,"controls-top"],[1,"btn-icon","btn-secondary","control-btn",3,"click"],[1,"controls-center"],[1,"gallery-button",3,"click"],["name","image"],[1,"capture-button",3,"click"],[1,"capture-button-inner"],[1,"controls-bottom"],[1,"info-card"],["name","info"]],template:function(e,r){e&1&&(n(0,"div",1)(1,"header",2)(2,"button",3),p("click",function(){return r.goBack()}),s(3,"lucide-icon",4),a(),n(4,"h1",5),m(5,"Klauen-Scan"),a(),s(6,"div",6),a(),n(7,"div",7),x(8,G,4,0,"div",8)(9,K,9,1,"div",9)(10,Q,2,0,"video",10)(11,q,7,0,"div",11),a(),x(12,W,16,2,"div",12),a()),e&2&&(l(8),f("ngIf",r.isLoading),l(),f("ngIf",r.error&&!r.isLoading),l(),f("ngIf",r.isCameraActive&&!r.isLoading),l(),f("ngIf",r.isCameraActive&&!r.isLoading),l(),f("ngIf",r.isCameraActive&&!r.isLoading))},dependencies:[F,A,L,V],styles:[".camera-container[_ngcontent-%COMP%]{position:fixed;inset:0;background:var(--gray-900);display:flex;flex-direction:column;overflow:hidden}.camera-header[_ngcontent-%COMP%]{position:relative;z-index:20;display:flex;align-items:center;justify-content:space-between;padding:var(--spacing-md);background:#00000080;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px)}.camera-title[_ngcontent-%COMP%]{font-size:1.25rem;font-weight:var(--font-weight-semibold);color:#fff;margin:0}.spacer[_ngcontent-%COMP%]{width:3rem}.camera-view[_ngcontent-%COMP%]{position:relative;flex:1;display:flex;align-items:center;justify-content:center;background:var(--gray-900);overflow:hidden}.video-preview[_ngcontent-%COMP%]{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:1}.loading-state[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:var(--spacing-lg);color:#fff}.loading-icon[_ngcontent-%COMP%]{font-size:3rem;color:var(--primary-500)}.error-state[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:var(--spacing-md);color:#fff;text-align:center;padding:var(--spacing-xl);max-width:400px}.error-icon[_ngcontent-%COMP%]{font-size:3rem;color:var(--error)}.error-state[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{color:#fff;margin:0}.error-state[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:var(--gray-300);margin:0}.guide-overlay[_ngcontent-%COMP%]{position:absolute;inset:0;pointer-events:none;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:var(--spacing-xl);z-index:2}.guide-frame[_ngcontent-%COMP%]{position:relative;width:80%;max-width:400px;aspect-ratio:1;border:3px dashed var(--primary-400);border-radius:var(--radius-lg);background:#0088ff1a;box-shadow:0 0 0 9999px #00000080}.guide-text[_ngcontent-%COMP%]{margin-top:var(--spacing-lg);text-align:center;padding:0 var(--spacing-xl)}.guide-text[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:#fff;font-weight:var(--font-weight-medium);margin:var(--spacing-xs) 0;text-shadow:0 2px 4px rgba(0,0,0,.5)}.camera-controls[_ngcontent-%COMP%]{position:relative;z-index:10;padding:var(--spacing-xl);background:linear-gradient(to top,rgba(0,0,0,.8),transparent);display:flex;flex-direction:column;gap:var(--spacing-lg)}.controls-top[_ngcontent-%COMP%]{display:flex;justify-content:space-between;gap:var(--spacing-md)}.control-btn[_ngcontent-%COMP%]{background:#fff3;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.3);color:#fff}.control-btn[_ngcontent-%COMP%]:hover{background:#ffffff4d}.control-btn.active[_ngcontent-%COMP%]{background:var(--primary-600);border-color:var(--primary-600)}.controls-center[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center;gap:2rem}.gallery-button[_ngcontent-%COMP%]{width:64px;height:64px;border-radius:50%;border:3px solid white;background:#fff3;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px);cursor:pointer;transition:all .2s ease;display:flex;align-items:center;justify-content:center;color:#fff}.gallery-button[_ngcontent-%COMP%]   lucide-icon[_ngcontent-%COMP%]{font-size:32px}.gallery-button[_ngcontent-%COMP%]:hover{transform:scale(1.05);background:#ffffff4d;box-shadow:0 0 20px #ffffff4d}.gallery-button[_ngcontent-%COMP%]:active{transform:scale(.95)}.capture-button[_ngcontent-%COMP%]{width:80px;height:80px;border-radius:50%;border:4px solid white;background:transparent;padding:6px;cursor:pointer;transition:all .2s ease;display:flex;align-items:center;justify-content:center}.capture-button[_ngcontent-%COMP%]:hover{transform:scale(1.05);box-shadow:0 0 20px #ffffff80}.capture-button[_ngcontent-%COMP%]:active{transform:scale(.95)}.capture-button-inner[_ngcontent-%COMP%]{width:100%;height:100%;border-radius:50%;background:#fff;transition:all .2s ease}.capture-button[_ngcontent-%COMP%]:hover   .capture-button-inner[_ngcontent-%COMP%]{background:var(--primary-500)}.controls-bottom[_ngcontent-%COMP%]{display:flex;justify-content:center}.info-card[_ngcontent-%COMP%]{display:inline-flex;align-items:center;gap:var(--spacing-sm);padding:var(--spacing-sm) var(--spacing-lg);background:#ffffff1a;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2);border-radius:var(--radius-lg);color:#fff;font-size:.875rem}.info-card[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{color:var(--primary-400)}@media (max-width: 768px){.camera-title[_ngcontent-%COMP%]{font-size:1.125rem}.guide-frame[_ngcontent-%COMP%]{width:90%}.capture-button[_ngcontent-%COMP%]{width:70px;height:70px}}"]})};export{j as CameraComponent};
